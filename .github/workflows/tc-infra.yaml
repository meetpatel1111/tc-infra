name: Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy (dev, test)"
        required: true
        default: "dev"
        type: choice
        options: [dev, test]

      action:
        description: "Terraform action (plan, apply, destroy, refresh)"
        required: false
        default: "apply"
        type: choice
        options: [plan, apply, destroy, refresh]

env:
  TF_DIR: .

  BACKEND_RG: tfstate-uks-shared-rg
  BACKEND_SA: sttfstateshared
  BACKEND_CONTAINER: tfstate
  BACKEND_LOCATION: eastus

  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

  ARM_CLIENT_ID:       ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
  ARM_CLIENT_SECRET:   ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
  ARM_TENANT_ID:       ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
  ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

jobs:
  terraform-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        auth-type: SERVICE_PRINCIPAL

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        terraform_wrapper: false

    - name: Set environment vars
      run: |
        echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
        echo "ACTION=${{ github.event.inputs.action || 'apply' }}" >> $GITHUB_ENV
        echo "STATE_KEY=tc/${{ github.event.inputs.environment }}.tfstate" >> $GITHUB_ENV
        echo "TFVARS_FILE=${{ github.event.inputs.environment }}.tfvars" >> $GITHUB_ENV

    - name: Pre-bootstrap Terraform backend
      run: |
        chmod +x ./prebootstrap.sh
        ./prebootstrap.sh \
          "${BACKEND_RG}" \
          "${BACKEND_SA}" \
          "${BACKEND_CONTAINER}" \
          "eastus"

    - name: Prepare tfvars (ensure exists + inject secrets)
      working-directory: ${{ env.TF_DIR }}
      run: |
        set -euo pipefail

        # If env tfvars doesn't exist, create from terraform.tfvars
        if [ ! -f "${TFVARS_FILE}" ]; then
          echo "No ${TFVARS_FILE} found. Creating from terraform.tfvars..."
          cp terraform.tfvars "${TFVARS_FILE}"
        fi

        # Replace placeholder password if present
        if grep -q "CHANGE_ME_STRONG_PASSWORD" "${TFVARS_FILE}"; then
          if [ -z "${{ secrets.TF_VM_ADMIN_PASSWORD }}" ]; then
            echo "TF_VM_ADMIN_PASSWORD secret is missing. Cannot replace placeholder."
            exit 1
          fi
          sed -i "s/CHANGE_ME_STRONG_PASSWORD/${{ secrets.TF_VM_ADMIN_PASSWORD }}/g" "${TFVARS_FILE}"
        fi

    - name: Terraform Init
      working-directory: ${{ env.TF_DIR }}
      run: |
        terraform init \
          -backend-config="resource_group_name=${BACKEND_RG}" \
          -backend-config="storage_account_name=${BACKEND_SA}" \
          -backend-config="container_name=${BACKEND_CONTAINER}" \
          -backend-config="key=${STATE_KEY}" \
          -backend-config="use_azuread_auth=true"

    - name: Terraform Format Check
      working-directory: ${{ env.TF_DIR }}
      run: terraform fmt -check -recursive

    - name: Terraform Validate
      working-directory: ${{ env.TF_DIR }}
      run: terraform validate

    - name: Terraform Execute
      working-directory: ${{ env.TF_DIR }}
      run: |
        set -euo pipefail

        case "${ACTION}" in
          plan)
            terraform plan -var-file="${TFVARS_FILE}"
            ;;
          apply)
            terraform plan -var-file="${TFVARS_FILE}" -out=tfplan
            terraform apply -auto-approve tfplan
            ;;
          destroy)
            terraform plan -destroy -var-file="${TFVARS_FILE}" -out=tfplan-destroy
            terraform apply -auto-approve tfplan-destroy
            ;;
          refresh)
            terraform refresh -var-file="${TFVARS_FILE}"
            ;;
          *)
            echo "Unknown action: ${ACTION}"
            exit 1
            ;;
        esac
