name: Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy (dev, test)"
        required: true
        default: "dev"
        type: choice
        options: [dev, test]

      action:
        description: "Terraform action (plan, apply, destroy, refresh)"
        required: false
        default: "apply"
        type: choice
        options: [plan, apply, destroy, refresh]

env:
  TF_DIR: .

  # Remote state backend (shared across envs)
  BACKEND_RG: tfstate-uks-shared-rg
  BACKEND_SA: sttfstateshared
  BACKEND_CONTAINER: tfstate
  BACKEND_LOCATION: eastus

  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

  # AzureRM Provider env vars for SP secret auth
  ARM_CLIENT_ID:       ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
  ARM_CLIENT_SECRET:   ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
  ARM_TENANT_ID:       ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
  ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

jobs:
  terraform-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login (Service Principal)
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        auth-type: SERVICE_PRINCIPAL
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        terraform_wrapper: false

    - name: Set environment vars
      run: |
        echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
        echo "ACTION=${{ github.event.inputs.action || 'apply' }}" >> $GITHUB_ENV
        echo "STATE_KEY=tc/${{ github.event.inputs.environment }}.tfstate" >> $GITHUB_ENV
        echo "TFVARS_FILE=${{ github.event.inputs.environment }}.tfvars" >> $GITHUB_ENV

    - name: Pre-bootstrap Terraform backend
      run: |
        chmod +x ./prebootstrap.sh
        ./prebootstrap.sh \
          "${BACKEND_RG}" \
          "${BACKEND_SA}" \
          "${BACKEND_CONTAINER}" \
          "eastus"

    - name: Prepare tfvars (ensure exists + inject secrets)
      working-directory: ${{ env.TF_DIR }}
      run: |
        set -euo pipefail

        # If env tfvars doesn't exist, create from terraform.tfvars
        if [ ! -f "${TFVARS_FILE}" ]; then
          echo "No ${TFVARS_FILE} found. Creating from terraform.tfvars..."
          cp terraform.tfvars "${TFVARS_FILE}"
        fi

        # Replace placeholder password if present
        if grep -q "CHANGE_ME_STRONG_PASSWORD" "${TFVARS_FILE}"; then
          if [ -z "${{ secrets.TF_VM_ADMIN_PASSWORD }}" ]; then
            echo "TF_VM_ADMIN_PASSWORD secret is missing. Cannot replace placeholder."
            exit 1
          fi
          sed -i "s/CHANGE_ME_STRONG_PASSWORD/${{ secrets.TF_VM_ADMIN_PASSWORD }}/g" "${TFVARS_FILE}"
        fi

    - name: Terraform Init (Remote Backend)
      working-directory: ${{ env.TF_DIR }}
      run: |
        set -euo pipefail
        terraform init \
          -backend-config="resource_group_name=${BACKEND_RG}" \
          -backend-config="storage_account_name=${BACKEND_SA}" \
          -backend-config="container_name=${BACKEND_CONTAINER}" \
          -backend-config="key=${STATE_KEY}" \
          -backend-config="use_azuread_auth=true"

    - name: Terraform Import (existing Recovery Vault replication settings)
      working-directory: ${{ env.TF_DIR }}
      run: |
        set -euo pipefail

        RG_NAME="rg-posterscope-tc"
        VAULT_NAME="vault411"

        ALERT_ADDR='module.recovery_vault.azapi_resource.replication_alert'
        ALERT_ID="/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.RecoveryServices/vaults/${VAULT_NAME}/replicationAlertSettings/defaultAlertSetting"

        VAULT_SETTINGS_ADDR='module.recovery_vault.azapi_resource.replication_vault_settings'
        VAULT_SETTINGS_ID="/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.RecoveryServices/vaults/${VAULT_NAME}/replicationVaultSettings/default"

        if ! terraform state list | grep -q "^${ALERT_ADDR}$"; then
          echo "Importing ${ALERT_ADDR}"
          terraform import -input=false "${ALERT_ADDR}" "${ALERT_ID}" || true
        fi

        if ! terraform state list | grep -q "^${VAULT_SETTINGS_ADDR}$"; then
          echo "Importing ${VAULT_SETTINGS_ADDR}"
          terraform import -input=false "${VAULT_SETTINGS_ADDR}" "${VAULT_SETTINGS_ID}" || true
        fi

    - name: Terraform Format Check
      working-directory: ${{ env.TF_DIR }}
      run: terraform fmt -check -recursive

    - name: Terraform Validate
      working-directory: ${{ env.TF_DIR }}
      run: terraform validate

    - name: Terraform Execute
      working-directory: ${{ env.TF_DIR }}
      run: |
        set -euo pipefail
        
        # Execute Terraform command based on action
        case "${ACTION}" in
          plan)
            terraform plan -input=false -var-file="${TFVARS_FILE}"
            ;;
          apply)
            terraform plan -input=false -var-file="${TFVARS_FILE}" -out=tfplan
            terraform apply -input=false -auto-approve tfplan
            ;;
          destroy)
            terraform plan -destroy -input=false -var-file="${TFVARS_FILE}" -out=tfplan-destroy
            terraform apply -input=false -auto-approve tfplan-destroy
            ;;
          refresh)
            terraform refresh -input=false -var-file="${TFVARS_FILE}"
            ;;
          *)
            echo "Unknown action: ${ACTION}"
            exit 1
            ;;
        esac
